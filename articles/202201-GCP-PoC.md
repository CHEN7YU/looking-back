# gcp的一个poc

## 无心插柳柳成荫
2021年初冬的一个不算太忙的下午，我还在楼上阁楼接到同事a一个兴高采烈的电话。\
a是一位硬核的devops工程师，她先问的我，“你的python技能怎么样？” \
我心里是有点虚的，很怕她问我一些oop，unit test这些没接触过的经历，实话实说：“我不算团队中代码最强的，之前用python写过一些etl”\
她倒倒是很兴奋：“我们有一个项目给外国一家银行做一个预警系统，在gcp平台使用nlp技术，自动识别新闻中的负面观点，并提供预警给风险管理部。加入我们吧，和谷歌一起合作，会有谷歌的专家给我们一些expert opinion的！”\
我一开始有点担心自己混不下去这类devops的项目，横竖当前也没别的项目可以参与，便也欣然答应了下来.\


几个礼拜的poc做下来，系统大概成型：
1. gcp cloud storage上传pdf/docx/refinitiv news
2. 上传动作触发gcp cloud function，对文本进行提取，将文本以json文件格式发给pub/sub message queue
3. 将以上步骤的文字拆分为段落，再次将文本以json文件格式发给pub/sub message queue
4. pub/sub再次触发新的gcp cloud function，使用google nlp api获取文本中的情感（sentiment）【-1，1】
5. 将结果（情感得分），标题，日期，渠道等字段写入google bigquery
6. 使用looker软件连接google bigquery 展现分析结果


不都一一赘述，写几个自己觉得震撼的地方：

## takeaways - Bigquery
**repeated fields** \
In traditional data warehouses, take a retail store as example, there are fact tables (eg. sales transcations) and dimensions tables (eg. customers, products, orders). 
Before this project, I thought this is the ONLY way for data warehouses.
In bigquery, you can actually only have 1 fact table and save those dimension tables into nested fields. When query fields from both base table and the nested field, you can unnest and cross join them: \

```
SELECT base.order_id, p.product_name              
FROM `pg-xx-n-app-12345.dwh.sales` base
CROSS JOIN UNNEST (product) as p
```



## takeaways - Looker
**a BI tool with native Git functions**\
Looking at those BI solutions listed in the Magic quardarants. No matter Power BI, Tableau or Qlik, there is no native function to use git software for data modeling version control. The calculated dimensions and table joins are not controlled in git. Alternatively, Qlik can use include statements to put the qlik scripts in txt files and tableau has function at server level to roll back 15 previous revisions.\
Initially I thought, 'Oh, it's just another visualization tool', while this 'niche' tier BI software has native function to use git for version control 2 type of source files:
1. .model file: relations of tables
2. .view file: fields in each tables

**LookerML**\
虽然没有想象的那么ml，却已经可以处理自动unnest bigquery repeated fields\
**Content Validator - update changes in batches**
When developing BI solutions, you may need to update fields names, which can be across multiple files and lines. The Looker content validator can search all model and view files and replace in batches, not only in backend code, but also front end UI visualizations. 

## automated deployment
我本对这一块不算很熟悉，看到我的2位队友部署了之后，还是很震撼，以下是流程：
1. a Developer finished a feature, committed locally and push to the remote repo.
2. automatically deploy on GCP (eg, have all guckets/ pubsub topics named ending with dev)
3. ...

## 项目管理
项目8周，分成4个spint，前三个用于研发，最后

**测试** 
更加积极主动的进程汇报，可以是邮件问清楚测试的预期，而不是等到一周2次汇报的时候，顾客当场说signal irrelvant

