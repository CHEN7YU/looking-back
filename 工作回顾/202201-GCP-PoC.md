# gcp的一个poc

## 无心插柳柳成荫
2021年初冬的一个不算太忙的下午，我还在楼上阁楼接到同事a一个兴高采烈的电话。\
a是一位硬核的devops工程师，她先问的我，“你的python技能怎么样？” \
我心里是有点虚的，很怕她问我一些oop，unit test这些没接触过的经历，实话实说：“我不算团队中代码最强的，之前用python写过一些etl”\
她倒倒是很兴奋：“我们有一个项目给外国一家银行做一个预警系统，在gcp平台使用nlp技术，自动识别新闻中的负面观点，并提供预警给风险管理部。加入我们吧，和谷歌一起合作，会有谷歌的专家给我们一些expert opinion的！”\
我一开始有点担心自己混不下去这类devops的项目，横竖当前也没别的项目可以参与，便也欣然答应了下来.

<br />
<br />


几个礼拜的poc做下来，系统大概成型：
1. gcp cloud storage上传pdf/docx/refinitiv news
2. 上传动作触发gcp cloud function，对文本进行提取，将文本以json文件格式发给pub/sub message queue
3. 将以上步骤的文字拆分为段落，再次将文本以json文件格式发给pub/sub message queue
4. pub/sub再次触发新的gcp cloud function，使用google nlp api获取文本中的情感（sentiment）[-1，1]
5. 将结果（情感得分），标题，日期，渠道等字段写入google bigquery
6. 使用looker软件连接google bigquery 展现分析结果

不都一一赘述，写几个自己觉得有记忆点的地方：
<br />
<br />

## takeaways - Bigquery
**repeated fields** \
In traditional data warehouses, take a retail store as example, there are fact tables (eg. sales transcations) and dimensions tables (eg. customers, products, orders). 
Before this project, I thought this is the ONLY way for data warehouses.
In bigquery, you can actually only have 1 fact table and save those dimension tables into nested fields. When query fields from both base table and the nested field, you can unnest and cross join them: \

```sql
SELECT base.order_id, p.product_name              
FROM `pg-xx-n-app-12345.dwh.sales` base
CROSS JOIN UNNEST (product) as p
```

<br />


## takeaways - Looker
**a BI tool with native Git functions**\
Looking at those BI solutions listed in the Magic quardarants. No matter Power BI, Tableau or Qlik, there is no native function to use git software for data modeling version control. The calculated dimensions and table joins are not controlled in git. Alternatively, Qlik can use include statements to put the qlik scripts in txt files and tableau has function at server level to roll back 15 previous revisions.\
Initially I thought, 'Oh, it's just another visualization tool', while this 'niche' tier BI software has native function to use git for version control 2 type of source files:
1. .model file: relations of tables
2. .view file: fields in each tables
<br />


**LookerML**\
虽然没有想象的那么ml，却已经可以处理自动unnest bigquery repeated fields\
<br />


**Content Validator - update changes in batches**\
When developing BI solutions, you may need to update fields names, which can be across multiple files and lines. The Looker content validator can search all model and view files and replace in batches, not only in backend code, but also front end UI visualizations. 
<br />


## automated deployment
我本对这一块不算很熟悉，看到我的2位队友部署了之后，还是很震撼，以下是流程：
1. a Developer finished a feature, committed locally and push to the remote repo.
2. automatically deploy on GCP (eg, have all guckets/ pubsub topics named ending with dev)
3. ...
<br />


## 顾客对PoC的验收 - 系统回测
项目8周，分成4个spint，前三个用于研发，最后一个sprint用于回测。 \
顾客挑了2个公司，给了我们25k篇新闻，让我们回测出2021年初关于这两家公司的负面新闻。 \
2周的sprint，安排了2次回测demo，都是我负责演示。 \
第一次我按照demo to win的方法论去演示，自己觉得完美，成功找到了这两家公司的负面新闻，顾客却表示这些新闻是“股票波动相关的新闻”，属于noise。让我们接着找回测的负面消息信号。 \
这一次，我们没有多问，便回头去返工了。 \
第二次demo找到了一些和股价波动无关的负面新闻，顾客却表示这不是导致这两家公司在3月股价暴跌的新闻。 \
我们全组当时就当机了。如果能重来一次，也许我们可以提前问清楚“谜底” -- 顾客到底要在什么时间，找到什么样的负面新闻？这样也会帮助我们回测。

### 20220129 更新 关于回测
这周一次团队会议上，Alex问道，“为什么我们不去让顾客给我们提供些关键字，看看能不能根据关键字找到这些文章？而不是现在想猜谜一样。有可能这些谜底暂时都不存储在我们的数据库。”
我们项目上一个经验丰富的总监答道：“scientifically，you are right, but we want to leave it like it is, the current conclusion of the final report is: recommend to provide more data.'.
他这么说我瞬间就懂了，如果顾客给了我们这些关键字，我们仍然没有找到（很有可能），那岂不是证明了自己的系统有故障？然而我们当前的状况反而比较保险，顾客让做测试，没有达到理想的情况，不过是因为顾客给的数据不够多。
